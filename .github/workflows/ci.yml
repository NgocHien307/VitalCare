# Health Tracker DSS - CI/CD Pipeline
# Runs on every push and pull request to main branch

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  JAVA_VERSION: "21"
  NODE_VERSION: "18"
  MONGODB_VERSION: "7.0"

jobs:
  # ============================================
  # Backend CI Job
  # ============================================
  backend:
    name: Backend CI (Java ${{ matrix.java }})
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      matrix:
        java: [21]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: "temurin"
          cache: maven

      - name: ðŸ”§ Make Maven Wrapper executable
        run: chmod +x ./mvnw

      - name: ðŸ”„ Wait for services to be ready
        run: |
          echo "Waiting for MongoDB and Redis..."
          sleep 5
          echo "Services ready!"

      - name: ðŸ“¦ Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸ” Run Tests
        run: ./mvnw test -B --file pom.xml
        env:
          SPRING_PROFILES_ACTIVE: test
          JWT_SECRET: test-jwt-secret-key-for-ci-pipeline-minimum-256-bits-required
          MONGODB_URI: mongodb://localhost:27017/healthtracker_test
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/healthtracker_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379

      - name: ðŸ“Š Generate Test Coverage Report
        run: ./mvnw jacoco:report -B --file pom.xml
        continue-on-error: true

      - name: ðŸ“¦ Build Package
        run: ./mvnw clean package -DskipTests -B --file pom.xml

      - name: ðŸ“¤ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: health-tracker-dss-jar
          path: target/*.jar
          retention-days: 7

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: target/surefire-reports/
          retention-days: 7
          if-no-files-found: ignore

      - name: ðŸ“¤ Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: coverage-report
          path: target/site/jacoco/
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # Frontend CI Job
  # ============================================
  frontend:
    name: Frontend CI (Node ${{ matrix.node }})
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    strategy:
      matrix:
        node: [18, 20]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Set up Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: npm ci || npm install

      - name: ðŸ” Run Linting
        run: npm run lint
        continue-on-error: true

      - name: ðŸ§ª Run Tests
        run: npm test
        continue-on-error: true
        env:
          CI: true

      - name: ðŸ—ï¸ Build
        run: npm run build

      - name: ðŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-node-${{ matrix.node }}
          path: frontend/dist/
          retention-days: 7

  # ============================================
  # Integration Tests Job
  # ============================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend]

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_DATABASE: healthtracker_integration_test
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' || mongo --quiet --eval 'db.runCommand({ ping: 1 }).ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: ðŸ”§ Make Maven Wrapper executable
        run: chmod +x ./mvnw

      - name: ðŸ”„ Wait for services to be ready
        run: |
          echo "Waiting for services to be healthy..."
          sleep 10
          echo "Services should be ready!"

      - name: ðŸ§ª Run Integration Tests
        run: ./mvnw verify -B --file pom.xml
        env:
          SPRING_PROFILES_ACTIVE: test
          JWT_SECRET: test-jwt-secret-key-for-ci-pipeline-minimum-256-bits-required
          MONGODB_URI: mongodb://localhost:27017/healthtracker_integration_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/healthtracker_integration_test
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379

      - name: ðŸ“¤ Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: target/failsafe-reports/
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # Security Scan Job
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [backend]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: ðŸ”§ Make Maven Wrapper executable
        run: chmod +x ./mvnw

      - name: ðŸ”’ OWASP Dependency Check
        run: ./mvnw dependency-check:check -B --file pom.xml
        continue-on-error: true
        timeout-minutes: 15

      - name: ðŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: target/dependency-check-report.html
          retention-days: 30
          if-no-files-found: ignore

  # ============================================
  # Build Status Summary
  # ============================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, integration]
    if: always()

    steps:
      - name: ðŸ“Š Check Build Status
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.backend.result }}" == "success" && "${{ needs.frontend.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All critical jobs passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Some jobs failed. Please check the logs.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
